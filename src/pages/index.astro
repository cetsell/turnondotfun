---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import HeroScene from '../components/HeroScene.jsx';
import InteractiveDemo from '../components/InteractiveDemo.jsx';
import FeatureCard from '../components/FeatureCard.jsx';
import Testimonial from '../components/Testimonial.jsx';
import FeatureImages from '../components/FeatureImages.jsx';

// Fetch featured worlds or stories
const { data: featuredWorlds } = await supabase
  .from('stories')
  .select('*')
  .limit(3);
---

<Layout title="MyWorld - Game World">
  <!-- Banner linking to the landing page -->
  <div class="bg-gradient-to-r from-purple-900 to-indigo-900 py-3 text-center">
    <p class="text-white">
      Check out our new <a href="/home" class="font-bold underline hover:text-purple-300">landing page</a> to learn more about MyWorld!
    </p>
  </div>
  
  <!-- Auth container -->
  <div id="auth-container" class="auth-container"></div>
  
  <!-- Game World Content (will only be visible when authenticated) -->
  <div id="game-content" class="p-8 hidden">
    <h1 class="text-3xl font-bold text-white mb-6">Welcome to the Game World</h1>
    <p class="text-xl text-gray-300 mb-8">
      This is the main game interface. Explore worlds, interact with characters, and create your own stories.
    </p>
    
    <!-- Featured Worlds -->
    <section class="max-w-7xl mx-auto px-4 py-8">
      <h2 class="text-2xl font-bold text-white mb-6">Featured Worlds</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {featuredWorlds?.map((world) => (
          <a href={`/worlds/${world.story_id}`} class="group">
            <div class="bg-gray-800 rounded-lg overflow-hidden">
              <div class="aspect-video bg-gray-900"></div>
              <div class="p-4">
                <h3 class="text-xl font-semibold text-white group-hover:text-purple-400">
                  {world.title}
                </h3>
                <p class="text-gray-400 mt-2">{world.description}</p>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>
  </div>
</Layout>

<script>
  import { createRoot } from 'react-dom/client';
  import { AuthRedirect } from '../client/components/AuthRedirect';
  import { supabase } from '../client/lib/supabase';
  
  // Initialize the auth redirect component
  const authContainer = document.getElementById('auth-container');
  const gameContent = document.getElementById('game-content');
  
  if (authContainer) {
    const root = createRoot(authContainer);
    root.render(<AuthRedirect />);
    
    // Check authentication status to show/hide game content
    const checkAuth = async () => {
      const { data } = await supabase.auth.getSession();
      if (data.session) {
        // User is authenticated, show game content
        gameContent.classList.remove('hidden');
      } else {
        // User is not authenticated, hide game content
        gameContent.classList.add('hidden');
      }
    };
    
    // Initial check
    checkAuth();
    
    // Subscribe to auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session) {
        gameContent.classList.remove('hidden');
      } else if (event === 'SIGNED_OUT') {
        gameContent.classList.add('hidden');
      }
    });
  }
</script>

<style>
  .auth-container {
    position: relative;
    z-index: 1000;
  }
  
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
  }
</style>
